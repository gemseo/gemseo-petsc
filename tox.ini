[tox]
minversion = 3.20.0
requires = tox-conda >=0.7.3

[testenv]
conda_channels=
    conda-forge
conda_install_args =
    # environment reproducibility: do not search default or .condarc channels
    --override-channels
conda_spec =
    requirements/gemseo-petsc-conda.txt
deps =
    git+https://gitlab.com/gemseo/dev/gemseo.git@develop
    -r requirements/test.txt
setenv =
    coverage: __COVERAGE_POSARGS=--cov-config setup.cfg --cov --cov-report=xml --cov-report=html
commands =
    pytest {env:__COVERAGE_POSARGS:} {posargs}

[testenv:check]
description = run code formatting and checking
basepython = python3.9
deps = -r requirements/check.txt
skip_install = true
whitelist_externals =
    git
commands =
    pre-commit install
    pre-commit run --all-files

[testenv:dist]
description = create and check the pypi distribution
basepython = python3.9
deps = -r requirements/dist.txt
skip_install = true
whitelist_externals = rm
commands =
    rm -rf dist build
    python -m build
    twine check dist/*
    python setup.py check --metadata

[testenv:update-deps-{test,doc,dist,check}]
description = update the envs dependencies with pip-compile
basepython = python3.9
extras =
setenv =
passenv =
deps =
    test: {[testenv]deps}
    dist: {[testenv:dist]deps}
    check: {[testenv:check]deps}
    pip-tools
skip_install = true
commands =
    test: pip-compile -U requirements/test.in
    dist: pip-compile -U requirements/dist.in
    check: pip-compile -U requirements/check.in
    check: pre-commit autoupdate
